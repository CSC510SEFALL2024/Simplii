name: Flask App CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies-1
        run: |
          python -m pip install --upgrade pip
          pip install Flask
          pip install pymongo
          pip install flask_pymongo
          pip install flask_mail
          pip install flask_wtf
          pip install wtforms
          pip install pytz
          pip install itsdangerous
          pip install werkzeug
          pip install schedule
          pip install apscheduler
          pip install tabulate
          pip install bcrypt
          pip install requests
          pip install openai
          pip install pytest
          pip install pytest-flask
      
      
      - name: Install dependencies-2
        run: |
          python -m pip install --upgrade pip
          pip install Flask pymongo flask_pymongo flask_mail flask_wtf wtforms[email] pytz itsdangerous werkzeug schedule apscheduler tabulate bcrypt requests openai pytest pytest-flask

      - name: Set PYTHONPATH
        run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV

      - name: Run Tests
        env:
          MONGO_URI: mongodb://localhost:27017/simplii_test
        run: pytest src/test_application.py --maxfail=1 --disable-warnings
