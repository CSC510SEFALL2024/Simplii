{% extends "layout.html" %}
{% block content %}
<div class="card status-card col-md">
    <div class="card-body">
        <!-- Use d-flex to align items on the same line, justify-content-between to space them out -->
        <div class="d-flex justify-content-between align-items-center">
            <!-- Title aligned to the left -->
            <h3 class="card-title mb-0">All Tasks</h3>
    
            <!-- Export button aligned to the right with an icon -->
            <button id="exportCSV" class="btn btn-primary">
                <i class="fas fa-download"></i> Export to CSV
            </button>
        </div>
    </div>

    <!-- Filter controls -->
    <div class="table-filter mb-4">
        <div class="row">
            <div class="col-sm-4">
                <div class="form-group">
                    <label for="ddlStatus">Status</label>
                    <select class="form-control" id="ddlStatus">
                        <option value="all">Select status</option>
                        <option value="To-Do">To-Do</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Done">Done</option>
                    </select>
                </div>
            </div>

            <div class="col-sm-4">
                <div class="form-group">
                    <label for="ddlCategory">Category</label>
                    <select class="form-control" id="ddlCategory">
                        <option value="all">Select category</option>
                        <option value="Physical">Physical</option>
                        <option value="Intellectual">Intellectual</option>
                    </select>
                </div>
            </div>

            <div class="col-sm-4">
                <div class="form-group">
                    <label for="ddlShow">Task display limit</label>
                    <select class="form-control" id="ddlShow">
                        <option value="all">Select limit</option>
                        <option value="3">3</option>
                        <option value="5">5</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Task table -->
    <div class="table-responsive">
        <table id="myTable" class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Task</th>
                    <th data-sortable="true">Status</th>
                    <th data-sortable="true">Category</th>
                    <th>Start Date</th>
                    <th>Due Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in tasks %}
                <tr>
                    <td>{{ item['taskname'] }}</td>
                    <td class="status-cell" 
                        data-status="{{ item['status'] }}">
                        {{ item['status'] }}
                    </td>
                    <td>{{ item['category'] }}</td>
                    <td>{{ item['startdate'] }}</td>
                    <td>{{ item['duedate'] }}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary editButton">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger deleteButton">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info reminderButton">
                                <i class="fas fa-bell"></i>
                            </button>
                            <a href="{{ item.gcal_link }}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-calendar-plus"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Include modern jQuery version -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Apply status colors using CSS classes
    $('.status-cell').each(function() {
        const status = $(this).data('status');
        switch(status) {
            case 'Done':
                $(this).addClass('bg-success text-white');
                break;
            case 'In Progress':
                $(this).addClass('bg-warning');
                break;
            case 'To-Do':
                $(this).addClass('bg-info text-white');
                break;
        }
    });

    // Handle filters
    function filterTable() {
        const status = $('#ddlStatus').val();
        const category = $('#ddlCategory').val();
        const limit = parseInt($('#ddlShow').val()) || 'all';

        $('#myTable tbody tr').each(function() {
            const $row = $(this);
            const rowStatus = $row.find('td:eq(1)').text().trim();
            const rowCategory = $row.find('td:eq(2)').text().trim();
            
            const statusMatch = status === 'all' || rowStatus === status;
            const categoryMatch = category === 'all' || rowCategory === category;
            
            $row.toggle(statusMatch && categoryMatch);
        });

        if (limit !== 'all') {
            $('#myTable tbody tr:visible').slice(limit).hide();
        }
    }

    // Attach filter handlers
    $('#ddlStatus, #ddlCategory, #ddlShow').on('change', filterTable);

    // CSV Export
    $('#exportCSV').click(function() {
        const rows = [];
        const headers = [];
        
        // Get headers (excluding Actions column)
        $('#myTable thead th').slice(0, -1).each(function() {
            headers.push($(this).text().trim());
        });
        rows.push(headers.join(','));

        // Get visible row data
        $('#myTable tbody tr:visible').each(function() {
            const rowData = [];
            $(this).find('td').slice(0, -1).each(function() {
                let data = $(this).text().trim();
                // Escape special characters
                data = data.replace(/"/g, '""');
                if (data.includes(',')) {
                    data = `"${data}"`;
                }
                rowData.push(data);
            });
            rows.push(rowData.join(','));
        });

        // Create and trigger download
        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'tasks.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
});
</script>
{% endblock content %}